name: CI

on:
  push:
    branches:
      - master
      - develop
  pull_request:
    branches:
      - master
  workflow_dispatch:

env:
  CPM_SOURCE_CACHE: ~/cpm-cache
  CCACHE_VERSION: 4.7.3
  CCACHE_BASEDIR: ${GITHUB_WORKSPACE}
  CCACHE_DIR: ${GITHUB_WORKSPACE}/.ccache
  CCACHE_COMPRESS: true
  CCACHE_COMPRESSLEVEL: 6
  CCACHE_MAXSIZE: 400M

jobs:
  build-and-test-linux-gcc-release:
    name: Build and test (linux-gcc-release)
    runs-on: ubuntu-latest
    container:
      image: lhamowski/devops:ubuntu-24.04-cpp-gcc-14-boost-1.89-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download ccache
        id: ccache
        shell: cmake -P {0}
        run: |
          set(ccache_url "https://github.com/cristianadam/ccache/releases/download/v$ENV{CCACHE_VERSION}/${{ runner.os }}.tar.xz")
          file(DOWNLOAD "${ccache_url}" ./ccache.tar.xz)
          execute_process(COMMAND ${CMAKE_COMMAND} -E tar xvf ./ccache.tar.xz)

      - name: Add ccache to PATH
        run: echo "$(pwd)" >> $GITHUB_PATH

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-linux-gcc-release-${{ github.sha }}
          restore-keys: ccache-linux-gcc-release-

      - name: Cache CPM packages
        uses: actions/cache@v4
        env:
          cache-name: cache-cmake-dependency-sources
        with:
          path: ${{ env.CPM_SOURCE_CACHE }}
          key: ${{ env.cache-name }}-${{ hashFiles('external/**') }}
          restore-keys: ${{ env.cache-name }}-

      - name: Configure
        run: |
          cmake --preset=linux-gcc-release \
                -DCMAKE_PREFIX_PATH=/usr/local/boost_1.89.0 \
                -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build
        run: cmake --build build/linux-gcc-release

      - name: Run tests
        run: cd build/linux-gcc-release && ctest -VV --output-on-failure

  build-and-test-linux-gcc-sanitizers:
    name: Build and test (linux-gcc-sanitizers)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    container:
      image: lhamowski/devops:ubuntu-24.04-cpp-gcc-14-boost-1.89-latest
    strategy:
      matrix:
        preset: [linux-gcc-asan, linux-gcc-tsan, linux-gcc-ubsan]
      fail-fast: false

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
              
      - name: Download ccache
        id: ccache
        shell: cmake -P {0}
        run: |
          set(ccache_url "https://github.com/cristianadam/ccache/releases/download/v$ENV{CCACHE_VERSION}/${{ runner.os }}.tar.xz")
          file(DOWNLOAD "${ccache_url}" ./ccache.tar.xz)
          execute_process(COMMAND ${CMAKE_COMMAND} -E tar xvf ./ccache.tar.xz)

      - name: Add ccache to PATH
        run: echo "$(pwd)" >> $GITHUB_PATH

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-${{ matrix.preset }}-${{ github.sha }}
          restore-keys: ccache-${{ matrix.preset }}-

      - name: Cache CPM packages
        uses: actions/cache@v4
        env:
          cache-name: cache-cmake-dependency-sources
        with:
          path: ${{ env.CPM_SOURCE_CACHE }}
          key: ${{ env.cache-name }}-${{ hashFiles('external/**') }}
          restore-keys: ${{ env.cache-name }}-

      - name: Configure
        run: |
          cmake --preset=${{ matrix.preset }} \
                -DCMAKE_PREFIX_PATH=/usr/local/boost_1.89.0 \
                -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build
        run: cmake --build build/${{ matrix.preset }}

      - name: Run tests
        run: cd build/${{ matrix.preset }} && ctest -VV --output-on-failure

  build-and-test-windows-msvc-release:
    name: Build and test (windows-msvc-release)
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@master

      - name: Setup MSVC Developer Command Prompt
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
          vsversion: "2022"

      - name: Install boost
        id: install-boost
        uses: MarkusJx/install-boost@6d8df42f57de83c5b326b5b83e7b35d650030103
        with:
          boost_version: 1.89.0
          platform_version: 2022
          toolset: msvc

      - name: Configure
        run: cmake --preset=windows-msvc-release -DCMAKE_PREFIX_PATH=${{ steps.install-boost.outputs.BOOST_ROOT }}

      - name: Build
        run: cmake --build build/windows-msvc-release

      - name: Run tests
        run: cd build/windows-msvc-release && ctest -VV --output-on-failure

  build-and-test-linux-clang-coverage:
    name: Build, test and generate coverage report (linux-clang-coverage)
    runs-on: ubuntu-latest
    container:
      image: lhamowski/devops:ubuntu-24.04-cpp-clang-19-boost-1.89-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download ccache
        id: ccache
        shell: cmake -P {0}
        run: |
          set(ccache_url "https://github.com/cristianadam/ccache/releases/download/v$ENV{CCACHE_VERSION}/${{ runner.os }}.tar.xz")
          file(DOWNLOAD "${ccache_url}" ./ccache.tar.xz)
          execute_process(COMMAND ${CMAKE_COMMAND} -E tar xvf ./ccache.tar.xz)

      - name: Add ccache to PATH
        run: echo "$(pwd)" >> $GITHUB_PATH

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-linux-clang-coverage-${{ github.sha }}
          restore-keys: ccache-linux-clang-coverage-

      - name: Cache CPM packages
        uses: actions/cache@v4
        env:
          cache-name: cache-cmake-dependency-sources
        with:
          path: ${{ env.CPM_SOURCE_CACHE }}
          key: ${{ env.cache-name }}-${{ hashFiles('external/**') }}
          restore-keys: ${{ env.cache-name }}-

      - name: Configure
        run: |
          cmake --preset=linux-clang-coverage \
                -DCMAKE_PREFIX_PATH=/usr/local/boost_1.89.0 \
                -DCMAKE_C_COMPILER_LAUNCHER=ccache \
                -DCMAKE_CXX_COMPILER_LAUNCHER=ccache


      - name: Build
        run: cmake --build build/linux-clang-coverage

      - name: Run tests and generate coverage report
        run: |
          cd build/linux-clang-coverage
          echo "=== Running tests with coverage ==="
          LLVM_PROFILE_FILE=coverage-%p.profraw ctest -VV --output-on-failure
          echo "=== Profile files in test directory ==="
          ls -la test/*.profraw || echo "No .profraw files found in test/"
          echo "=== Merging profile files ==="
          llvm-profdata-19 merge --sparse test/*.profraw -o coverage.profdata
          echo "=== Generating coverage report ==="
          find ./src -name '*.o' | xargs -I{} echo "-object={}" > object_list.txt
          llvm-cov-19 export ./test/lux-test \
              -instr-profile=coverage.profdata \
              -format=lcov \
              -ignore-filename-regex=".*test/.*" \
              $(cat object_list.txt) \
              > coverage.info

      - name: Upload coverage report
        uses: codecov/codecov-action@v5
        with:
          fail_ci_if_error: true
          directory: build/linux-clang-coverage
          files: build/linux-clang-coverage/coverage.info
          flags: unittests
          name:  lux-coverage
          disable_search: true
          token: ${{ secrets.CODECOV_TOKEN }}
